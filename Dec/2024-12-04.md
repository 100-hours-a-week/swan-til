
### 개요
이번 딥다이브 시간을 통해 NLB 와 ALB 에 대해서 알게되었습니다.<br>

그 중 눈에 들어오는 부분은 4계층인 NLB에선 SSL TLS 프로토콜을 처리할 수 없다는 것이였는데요.<br>

이게 듣기에 따라 애플리케이션 단에서 HTTPS로 요청한 패킷은 NLB에서 처리를 할 수 없다고도 들려 혼란스러웠습니다.<br>
(이후에 제가 이해하기론 HTTPS 프로토콜도 4계층에와선 TCP, UDP 들로 변경되니 처리에 문제 없습니다. 
대신 4계층 자체에선 SSL TLS에 대한 핸드셰이킹이나 복호화 과정을 수행할 수 없다는 점을 신경써야합니다.)<br>
<br>

처음에 들었을 땐 이게 왜 문제가 되는거지 싶었습니다.<br>
애초에 4계층에서 TLS 복호화가 지원되지 않는건 설계적으로 당연한게 아닌가요?<br>
4계층에서 TLS 복호화를 시도하는 행위 자체가 꽤 위험해보이는데<br>
4계층에서 TLS 복호화를 해야하는 이유가 있을까요?<br>

위는 4계층 자체의 특성과 관련되어 있는데 좀 더 NLB로 이야기를 한정하자면<br>
NLB에선 기본적으로 IP 와 PORT를 이용해 규칙을 적용하고 이 IP, PORT 는 TLS 로 암호화된 페이로드가 아닌<br>
헤더에서 담당하고 있어 TLS 복호화를 할 필요도 없습니다.<br>

굳이 4계층에서 TLS 복호화를 하려는 이유가 뭘까요..?<br>


### ChatGPT의 답변
ChatGPT 한테 물어봤습니다. (아래부터는 GPT 선생님의 답변입니다. 유료를 쓰니 확실히 답변에 진심이 느껴지네요.)<br>
<br>

```
좋은 질문입니다! NLB와 ALB를 이해하면서 4계층에서 TLS 복호화가 필요하지 않아 보이는 이유와, 그럼에도 불구하고 TLS 복호화를 시도하는 경우가 있는 이유를 정리해 보겠습니다. 
1. 4계층에서 TLS 복호화가 필요 없어 보이는 이유

4계층 로드 밸런서(NLB)의 설계와 TLS의 동작 원리를 이해하면, TLS 복호화가 필요하지 않은 이유는 다음과 같습니다:

4계층의 특성:

	• NLB는 IP, 포트, 프로토콜(TCP/UDP) 정보를 기반으로 트래픽을 라우팅합니다.
	• TCP/UDP 헤더와 IP 헤더는 TLS 암호화의 영향을 받지 않으므로, 복호화 없이도 트래픽을 목적지로 전달할 수 있습니다.
	• 암호화된 페이로드(TLS 데이터)는 4계층에서 볼 필요가 없습니다.

TLS의 헤더와 암호화:

	• TLS는 애플리케이션 계층(HTTP 등)의 데이터를 보호하며, IP와 TCP 헤더는 암호화되지 않습니다.
	• 따라서 4계층에서 트래픽을 안전하게 라우팅하는 데는 TLS 복호화가 필요 없습니다.

결론적으로, 4계층에서 TLS 복호화를 하지 않아도 NLB는 기본 역할을 수행할 수 있습니다. 이는 NLB의 설계 철학과도 일치합니다.

---

2. 4계층에서 TLS 복호화를 하려는 이유

그럼에도 불구하고, TLS 복호화가 필요하거나 시도되는 이유는 특정 요구사항 때문입니다. 이 요구사항은 네트워크 보안, 성능, 또는 관리 측면에서 발생할 수 있습니다.

(1) 중앙에서 인증서 관리

	• 문제: 백엔드 서버 각각에 인증서를 설치하고 관리하는 것은 번거롭고 복잡합니다.
	• 해결: NLB가 TLS 핸드셰이크를 처리하여 인증서를 중앙에서 관리하면, 백엔드 서버는 TLS 설정 없이 평문 데이터를 처리할 수 있습니다.
	• AWS NLB의 TLS 리스너는 이러한 요구사항을 해결하기 위해 제공됩니다.

(2) 백엔드 서버의 부담 감소

	• 문제: TLS 핸드셰이크와 데이터 암호화/복호화는 CPU에 부담을 줍니다.
	• 해결: NLB가 복호화를 처리하면, 백엔드 서버는 암호화 작업을 피하고 성능을 최적화할 수 있습니다.
	• 특히 대규모 트래픽 처리 환경에서 유용합니다.

(3) 트래픽 분석 및 보안 정책 적용

	• 문제: 암호화된 트래픽을 분석하거나 특정 보안 정책(IP 방화벽, 로깅)을 적용하려면, 데이터 페이로드를 읽어야 합니다.
	• 해결: NLB가 TLS를 복호화하면, 로깅 및 보안 정책을 쉽게 적용할 수 있습니다.

---

3. 4계층 TLS 복호화는 위험한가?

4계층에서 TLS 복호화가 위험해 보이는 이유는 보안 우려 때문일 수 있습니다. 하지만 적절한 방식으로 TLS 복호화를 수행하면 안전하게 운영할 수 있습니다.

(1) 복호화 위치의 보안

	• TLS 복호화를 NLB에서 수행하는 경우, 로드 밸런서가 신뢰할 수 있는 환경이어야 합니다.
	• AWS NLB의 경우, AWS Certificate Manager(ACM)와 통합하여 인증서를 관리하므로 복호화 프로세스를 안전하게 처리할 수 있습니다.

(2) 종단 간 암호화

	• TLS 복호화를 NLB에서 수행하면 클라이언트와 NLB 간의 트래픽은 암호화되지만, NLB와 백엔드 서버 간의 트래픽은 평문으로 전송될 수 있습니다.
	• 이를 해결하기 위해, NLB에서 복호화 후 백엔드 서버와의 연결에서도 TLS를 재적용하는 “종단 간 암호화” 방식을 사용할 수 있습니다.


Client --> NLB (TLS 복호화) --> Backend (TLS 재암호화)

---

4. NLB에서 TLS 복호화를 선택하는 이유 요약

	1. 중앙화된 인증서 관리:
	  • 여러 백엔드 서버에서 TLS를 설정할 필요 없이, NLB가 대신 인증서를 관리합니다.
	2. 백엔드 성능 최적화:
	  • 백엔드 서버가 암호화/복호화 부담에서 벗어나 애플리케이션 처리에 집중할 수 있습니다.
	3. 보안 분석 및 로깅:
	  • 복호화된 데이터에 기반한 보안 정책 적용이나 로깅이 가능해집니다.
	4. 멀티 프로토콜 지원:
	  • 비HTTP 트래픽(gRPC, MQTT 등)에서도 TLS 핸드셰이크를 처리할 수 있어, 다양한 애플리케이션 요구를 만족합니다.

---

결론

4계층에서 TLS 복호화를 하지 않는 것이 기본적이고 자연스러워 보이지만, 실제로 TLS 복호화를 해야 하는 경우는 관리와 성능 최적화, 보안 분석 등 실무적인 이유에서 발생합니다. NLB는 기본적으로 TLS 복호화를 하지 않지만, 필요 시 TLS 리스너를 통해 이를 지원하며, 이는 특정 시나리오에서 매우 유용한 옵션입니다.

이 점을 이해하면, 4계층에서 TLS 복호화를 시도하는 이유가 실무적 요구사항에 기인한다는 것을 알 수 있습니다.

```


<br>

음음 확실히 분산환경에서 인증정보를 각각 관리한다는건 관리복잡도가 꽤 크긴 합니다. <br>
그런 점에서 로드밸런스 수준에서 중앙화된 보안처리를 한다는건 꽤 의미가 있어보이네요.<br>
(ChatGPT 돈값 하는구만! )<br>
<br>

**인증 정보를 개별적으로 관리하는게 귀찮은 이유**
- 인증서는 유효기간이 있어 일정 기간 이후 갱신해야합니다.
- 오토스케일링 등 동적으로 인증서를 추가해줘야해 자동화 기능을 구현해야합니다.
- 이러한 귀찮음은 휴먼 에러로 이어질 수 있고 큰 장애를 일으킬 수도 있습니다.

<br>

요것들 말고도 더 실용적인 이유가 있을것 같은데 그건 스스로 배워보고 싶습니다.



